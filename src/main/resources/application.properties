spring.application.name=backend-ecommerce-template

# ============================================================
# VIRTUAL THREADS (Java 25 — Project Loom)
# ============================================================

# Habilita hilos virtuales: mejora drásticamente la concurrencia con mínimo uso
# de memoria. Cada request usa un hilo virtual en vez de uno de plataforma,
# ideal para operaciones I/O-bound (PostgreSQL, Redis, Cloudinary).
spring.threads.virtual.enabled=true

# ============================================================
# SERVER
# ============================================================

server.port=8080
server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=30s

# Compresión HTTP: reduce tamaño de respuestas JSON grandes
server.compression.enabled=true
server.compression.mime-types=application/json,application/xml,text/html,text/plain
server.compression.min-response-size=1024

# Tomcat: con hilos virtuales habilitados, threads.max pierde relevancia porque
# cada request se atiende en un hilo virtual. Se mantienen como límite de seguridad.
server.tomcat.threads.max=50
server.tomcat.threads.min-spare=5
server.tomcat.accept-count=50
server.tomcat.connection-timeout=10s
server.tomcat.keep-alive-timeout=30s
server.tomcat.max-keep-alive-requests=100
server.tomcat.max-connections=200

# ============================================================
# DATASOURCE (PostgreSQL + HikariCP)
# ============================================================

spring.datasource.url=jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}

# HikariCP: pool reducido para optimizar memoria en plan Free (512 MB)
spring.datasource.hikari.maximum-pool-size=3
spring.datasource.hikari.minimum-idle=1
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=600000
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.pool-name=ECommerceHikariPool
# auto-commit=false junto con provider_disables_autocommit evita roundtrip extra por transacción
spring.datasource.hikari.auto-commit=false
spring.datasource.hikari.leak-detection-threshold=30000

# ============================================================
# JPA / HIBERNATE
# ============================================================

spring.jpa.hibernate.ddl-auto=validate
spring.jpa.open-in-view=false

spring.jpa.properties.hibernate.jdbc.batch_size=10
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true

spring.jpa.properties.hibernate.connection.provider_disables_autocommit=true
spring.jpa.properties.hibernate.query.in_clause_parameter_padding=true
spring.jpa.properties.hibernate.query.plan_cache_max_size=512
spring.jpa.properties.hibernate.query.fail_on_pagination_over_collection_fetch=true

spring.jpa.properties.hibernate.jdbc.time_zone=UTC
spring.jpa.properties.hibernate.generate_statistics=false

# ============================================================
# REDIS
# ============================================================

spring.data.redis.url=${REDIS_URL}
spring.data.redis.timeout=5000ms

# Lettuce pool: reducido para plan Free (512 MB RAM).
# Con hilos virtuales, menos conexiones activas manejan más concurrencia efectiva.
spring.data.redis.lettuce.pool.enabled=true
spring.data.redis.lettuce.pool.max-active=4
spring.data.redis.lettuce.pool.max-idle=4
spring.data.redis.lettuce.pool.min-idle=1
spring.data.redis.lettuce.pool.max-wait=2000ms
spring.data.redis.lettuce.pool.time-between-eviction-runs=60s
spring.data.redis.lettuce.shutdown-timeout=200ms

# ============================================================
# CACHE (Redis-backed)
# ============================================================

spring.cache.type=redis
spring.cache.redis.time-to-live=600000
spring.cache.redis.key-prefix=ecommerce:
spring.cache.redis.use-key-prefix=true
spring.cache.redis.cache-null-values=false

# ============================================================
# ACTUATOR + PROMETHEUS
# ============================================================

management.endpoints.web.exposure.include=health,info,metrics,prometheus,caches,loggers
management.endpoint.health.show-details=when-authorized
management.endpoint.health.probes.enabled=true
management.health.livenessstate.enabled=true
management.health.readinessstate.enabled=true
# Si se re-habilita el endpoint 'env', esta propiedad enmascara valores sensibles
management.endpoint.env.show-values=when-authorized

management.info.env.enabled=true
management.info.build.enabled=true
management.info.java.enabled=true
management.info.os.enabled=true
info.app.name=${spring.application.name}
info.app.description=Plantilla Backend para un E-commerce
info.app.version=0.0.1-SNAPSHOT

management.prometheus.metrics.export.enabled=true
management.metrics.tags.application=${spring.application.name}
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.slo.http.server.requests=50ms,100ms,200ms,500ms,1s

# ============================================================
# SECURITY
# ============================================================

# En producción SIEMPRE definir SECURITY_USER y SECURITY_PASSWORD como variables de entorno.
spring.security.user.name=${SECURITY_USER}
spring.security.user.password=${SECURITY_PASSWORD}

# ============================================================
# RESILIENCE4J (Circuit Breaker)
# ============================================================

# Nota: estas configuraciones definen comportamiento por defecto para futuros
# @CircuitBreaker, @Retry y @TimeLimiter. Actualmente no se usan en los servicios,
# pero quedan listas para cuando se integren (ej: llamadas a Cloudinary o APIs externas).

resilience4j.circuitbreaker.configs.default.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.configs.default.sliding-window-size=10
resilience4j.circuitbreaker.configs.default.minimum-number-of-calls=5
resilience4j.circuitbreaker.configs.default.failure-rate-threshold=50
resilience4j.circuitbreaker.configs.default.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.configs.default.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.configs.default.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.configs.default.register-health-indicator=true
resilience4j.circuitbreaker.configs.default.slow-call-rate-threshold=80
resilience4j.circuitbreaker.configs.default.slow-call-duration-threshold=3s

resilience4j.retry.configs.default.max-attempts=3
resilience4j.retry.configs.default.wait-duration=1s
resilience4j.retry.configs.default.enable-exponential-backoff=true
resilience4j.retry.configs.default.exponential-backoff-multiplier=2

resilience4j.timelimiter.configs.default.timeout-duration=5s
resilience4j.timelimiter.configs.default.cancel-running-future=true

management.health.circuitbreakers.enabled=true

# ============================================================
# JACKSON (Serialización JSON)
# ============================================================

spring.jackson.deserialization.fail-on-unknown-properties=false
spring.jackson.default-property-inclusion=non_null
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.time-zone=UTC

# ============================================================
# PAGINATION
# ============================================================

spring.data.web.pageable.default-page-size=20
spring.data.web.pageable.max-page-size=100
spring.data.web.pageable.one-indexed-parameters=true

# ============================================================
# CLOUDINARY
# ============================================================

cloudinary.cloud-name=${CLOUDINARY_CLOUD_NAME:your_cloud_name}
cloudinary.api-key=${CLOUDINARY_API_KEY:your_api_key}
cloudinary.api-secret=${CLOUDINARY_API_SECRET:your_api_secret}

# ============================================================
# MULTIPART (File Upload)
# ============================================================

spring.servlet.multipart.max-file-size=5MB
spring.servlet.multipart.max-request-size=10MB
spring.servlet.multipart.file-size-threshold=256KB

# ============================================================
# ERROR HANDLING
# ============================================================

server.error.include-stacktrace=never
server.error.include-message=always
server.error.include-binding-errors=always

# ============================================================
# LOGGING
# ============================================================

logging.level.root=INFO
logging.level.com.zaxxer.hikari=INFO
logging.level.org.springframework.security=INFO
logging.level.io.github.resilience4j=INFO
logging.level.org.e_commerce.backend_template=DEBUG

logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n
logging.file.name=logs/backend-ecommerce-template.log
logging.logback.rollingpolicy.max-file-size=10MB
logging.logback.rollingpolicy.max-history=7
logging.logback.rollingpolicy.total-size-cap=100MB
