# Render Blueprint — Infraestructura como Código
# Docs: https://docs.render.com/blueprint-spec
#
# Base de datos: PostgreSQL en Neon (externo) — no expira, autoscale, pooling integrado
# Redis + API: gestionados por Render

services:
  # Redis gestionado por Render
  - type: redis
    name: ecommerce-redis
    plan: free
    region: oregon
    maxmemoryPolicy: allkeys-lru
    ipAllowList: [] # Solo conexiones internas de Render

  # API de Java (Web Service)
  - type: web
    name: ecommerce-api
    runtime: docker
    region: oregon
    plan: free
    dockerfilePath: ./Dockerfile
    envVars:
      # --- Base de datos (Neon — configurar manualmente en dashboard) ---
      - key: DB_HOST
        sync: false
      - key: DB_PORT
        value: "5432"
      - key: DB_NAME
        sync: false
      - key: DB_USERNAME
        sync: false
      - key: DB_PASSWORD
        sync: false

      # --- Redis ---
      - key: REDIS_URL
        fromService:
          name: ecommerce-redis
          type: redis
          property: connectionString

      # --- Security ---
      - key: SECURITY_USER
        generateValue: true
      - key: SECURITY_PASSWORD
        generateValue: true

      # --- Cloudinary (definir manualmente en el dashboard) ---
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false

      # --- Spring Profile ---
      - key: SPRING_PROFILES_ACTIVE
        value: prod
    healthCheckPath: /actuator/health/liveness
    numInstances: 1
